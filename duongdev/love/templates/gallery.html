{% extends 'base.html' %}

{% block content %}
<div class="page-header">
    <h1><i class="fas fa-images"></i> Kho ảnh kỷ niệm</h1>
    <p>Những khoảnh khắc đẹp nhất của chúng mình</p>
</div>

<!-- Upload section -->
<div class="add-section">
    <button class="btn-add" id="toggleUploadForm">
        <i class="fas fa-cloud-upload-alt"></i> Tải ảnh lên
    </button>
    
    <form class="add-form upload-form" id="uploadForm" action="{{ url_for('upload_photo') }}" method="POST" enctype="multipart/form-data" style="display: none;">
        <div class="upload-area" id="uploadArea">
            <i class="fas fa-image"></i>
            <p>Kéo thả ảnh vào đây hoặc click để chọn</p>
            <input type="file" id="photo" name="photo" accept="image/*" required>
        </div>
        <div class="upload-preview" id="uploadPreview"></div>
        
        <div class="form-row">
            <div class="form-group">
                <label for="caption">Chú thích</label>
                <input type="text" id="caption" name="caption" placeholder="Mô tả bức ảnh...">
            </div>
            <div class="form-group">
                <label for="date_taken">Ngày chụp</label>
                <input type="date" id="date_taken" name="date_taken">
            </div>
        </div>
        
        <div class="form-actions">
            <button type="submit" class="btn-primary">
                <i class="fas fa-upload"></i> Tải lên
            </button>
            <button type="button" class="btn-secondary" id="cancelUpload">Hủy</button>
        </div>
    </form>
</div>

<!-- Photo gallery -->
<div class="gallery-grid">
    {% if photos %}
        {% for photo in photos %}
        <div class="gallery-item" 
             data-img-src="{{ url_for('static', filename='uploads/' ~ photo.filename) }}"
             data-caption="{{ photo.caption or 'Kỷ niệm đẹp' }}">
            <img src="{{ url_for('static', filename='uploads/' ~ photo.filename) }}" alt="{{ photo.caption }}">
            <div class="gallery-overlay">
                <span class="photo-caption">{{ photo.caption or 'Kỷ niệm đẹp' }}</span>
                <span class="photo-date">{{ photo.date_taken.strftime('%d/%m/%Y') if photo.date_taken else '' }}</span>
            </div>
            <button class="btn-delete-photo" data-delete-url="{{ url_for('delete_photo', id=photo.id) }}">
                <i class="fas fa-trash"></i>
            </button>
        </div>
        {% endfor %}
    {% else %}
        <div class="empty-state">
            <i class="fas fa-camera"></i>
            <h3>Chưa có ảnh nào</h3>
            <p>Hãy tải lên những bức ảnh đẹp nhất của hai bạn!</p>
        </div>
    {% endif %}
</div>

<!-- Lightbox -->
<div class="lightbox" id="lightbox">
    <button class="lightbox-close" id="lightboxClose">
        <i class="fas fa-times"></i>
    </button>
    <img src="" alt="" id="lightboxImg">
    <p class="lightbox-caption" id="lightboxCaption"></p>
</div>

<!-- Delete modal -->
<div class="modal" id="deleteModal">
    <div class="modal-content">
        <h3>Xác nhận xóa</h3>
        <p>Bạn có chắc muốn xóa ảnh này không?</p>
        <div class="modal-actions">
            <a href="#" id="confirmDeleteBtn" class="btn-danger">Xóa</a>
            <button type="button" class="btn-secondary" id="cancelDeleteBtn">Hủy</button>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    // Toggle form
    document.getElementById('toggleUploadForm').addEventListener('click', function() {
        var form = document.getElementById('uploadForm');
        form.style.display = form.style.display === 'none' ? 'block' : 'none';
        this.style.display = 'none';
    });
    
    document.getElementById('cancelUpload').addEventListener('click', function() {
        document.getElementById('uploadForm').style.display = 'none';
        document.getElementById('toggleUploadForm').style.display = 'block';
    });
    
    // Upload preview
    document.getElementById('photo').addEventListener('change', function(e) {
        var preview = document.getElementById('uploadPreview');
        preview.innerHTML = '';
        
        if (this.files && this.files[0]) {
            var reader = new FileReader();
            reader.onload = function(e) {
                preview.innerHTML = '<img src="' + e.target.result + '" alt="Preview">';
            };
            reader.readAsDataURL(this.files[0]);
        }
    });
    
    // Drag and drop
    var uploadArea = document.getElementById('uploadArea');
    
    uploadArea.addEventListener('dragover', function(e) {
        e.preventDefault();
        this.classList.add('dragover');
    });
    
    uploadArea.addEventListener('dragleave', function() {
        this.classList.remove('dragover');
    });
    
    uploadArea.addEventListener('drop', function(e) {
        e.preventDefault();
        this.classList.remove('dragover');
        document.getElementById('photo').files = e.dataTransfer.files;
        
        // Trigger change event
        var event = new Event('change');
        document.getElementById('photo').dispatchEvent(event);
    });
    
    // Gallery item click - open lightbox
    document.querySelectorAll('.gallery-item').forEach(function(item) {
        item.addEventListener('click', function(e) {
            // Không mở lightbox nếu click vào nút delete
            if (e.target.closest('.btn-delete-photo')) return;
            
            var src = this.getAttribute('data-img-src');
            var caption = this.getAttribute('data-caption');
            
            document.getElementById('lightboxImg').src = src;
            document.getElementById('lightboxCaption').textContent = caption;
            document.getElementById('lightbox').classList.add('active');
        });
    });
    
    // Close lightbox
    document.getElementById('lightboxClose').addEventListener('click', function() {
        document.getElementById('lightbox').classList.remove('active');
    });
    
    document.getElementById('lightbox').addEventListener('click', function(e) {
        if (e.target === this) {
            this.classList.remove('active');
        }
    });
    
    // Delete photo
    document.querySelectorAll('.btn-delete-photo').forEach(function(btn) {
        btn.addEventListener('click', function(e) {
            e.stopPropagation();
            var url = this.getAttribute('data-delete-url');
            document.getElementById('confirmDeleteBtn').href = url;
            document.getElementById('deleteModal').classList.add('active');
        });
    });
    
    document.getElementById('cancelDeleteBtn').addEventListener('click', function() {
        document.getElementById('deleteModal').classList.remove('active');
    });
    
    document.getElementById('deleteModal').addEventListener('click', function(e) {
        if (e.target === this) {
            this.classList.remove('active');
        }
    });
</script>
{% endblock %}